<!DOCTYPE html>
<html lang="en">

<head>
  <title>mihr</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="demo-styles.css" />
  <script src="font.json"></script>
  <script src="https://unpkg.com/marked@11.1.1"></script>
  <script src="https://unpkg.com/three@0.145.0"></script>
  <script src="https://unpkg.com/three@0.145.0/examples/js/controls/TrackballControls.js"></script>
  <script src="https://unpkg.com/three@0.145.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.145.0/examples/js/loaders/FontLoader.js"></script>
  <script src="https://unpkg.com/three-globe@2.24.13"></script>
</head>

<body>
  <div id="globeViz"></div>
  <div style="position: absolute; top: 10px; left: 10px; z-index: 1;">
    <select id="layer-select">
      <option value="mihrbase.png">Default</option>
      <option value="mihrborder.png">Borders</option>
    </select>
    <select id="locations-select">
      <option value="all">All</option>
      <option value="continents">Continents</option>
      <option value="nations">Nations</option>
      <option value="cities">Cities</option>
      <option value="geography">Geography</option>
    </select>
  </div>
  <div id="info-panel" style="position: absolute; top: 10px; right: 10px; z-index: 2; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; max-width: 300px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: none; max-height: 80vh; overflow-y: auto;">
    <style>
      #info-panel h1, #info-panel h2, #info-panel h3, #info-panel h4, #info-panel h5, #info-panel h6 { margin: 10px 0 5px 0; font-size: inherit; }
      #info-panel h1 { font-size: 18px; }
      #info-panel strong { font-weight: bold; }
      #info-panel em { font-style: italic; }
      #info-panel ul, #info-panel ol { margin: 5px 0; padding-left: 20px; }
      #info-panel li { margin: 3px 0; }
      #info-panel code { background: #f0f0f0; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 12px; }
      #info-panel pre { background: #f0f0f0; padding: 8px; border-radius: 3px; overflow-x: auto; }
      #info-panel a { color: #0066cc; text-decoration: none; }
      #info-panel a:hover { text-decoration: underline; }
      #info-panel p { margin: 5px 0; }
    </style>
    <button id="close-panel" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
    <div id="info-content" style="margin: 0; font-size: 14px; color: #333; line-height: 1.5;"></div>
  </div>
  <script type="module">
    const loader = new THREE.FontLoader();
    const font = await loader.loadAsync('font.json');
    const geoData = await fetch('https://raw.githubusercontent.com/mihr-globe/mihr-globe.github.io/refs/heads/main/labels.json').then(res => res.json());
    let layer = 'mihrbase.png';
    let locationsLayer = 'all';
    let globe = setupGlobe('https://raw.githubusercontent.com/mihr-globe/mihr-globe.github.io/refs/heads/main/mihrbase.png', "all")

    // Setup renderer
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('globeViz').appendChild(renderer.domElement);

    // Setup scene
    const scene = new THREE.Scene();
    scene.add(globe);
    scene.add(new THREE.AmbientLight(0xbbbbbb));
    scene.add(new THREE.DirectionalLight(0xffffff, 0.6));

    // Setup camera
    const camera = new THREE.PerspectiveCamera();
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    camera.position.z = 500;

    // Add camera controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.minDistance = 101;

    // Handle globe clicks
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function findNearbyLabel(lat, lon, threshold = 3) {
      // Get all labels
      const allLabels = [...geoData.continents, ...geoData.nations, ...geoData.cities, ...geoData.geography];
      
      // Find label closest to click point
      let closestLabel = null;
      let closestDistance = threshold;
      
      for (const label of allLabels) {
        const distance = Math.sqrt(Math.pow(label.lat - lat, 2) + Math.pow(label.lng - lon, 2));
        if (distance < closestDistance) {
          closestDistance = distance;
          closestLabel = label;
        }
      }
      
      return closestLabel;
    }

    async function showInfoPanel(label) {
      const panel = document.getElementById('info-panel');
      const content = document.getElementById('info-content');
      
      if (!label.id) {
        content.innerHTML = '<p>No description available.</p>';
        panel.style.display = 'block';
        return;
      }
      
      try {
        const markdownUrl = `https://raw.githubusercontent.com/mihr-globe/mihr-globe.github.io/refs/heads/main/descriptions/${label.id}.md`;
        const response = await fetch(markdownUrl);
        
        if (!response.ok) {
          content.innerHTML = '<p>No description available.</p>';
        } else {
          const markdown = await response.text();
          content.innerHTML = marked.parse(markdown);
        }
      } catch (error) {
        console.error('Error loading description:', error);
        content.innerHTML = '<p>Error loading description.</p>';
      }
      
      panel.style.display = 'block';
    }

    function hideInfoPanel() {
      document.getElementById('info-panel').style.display = 'none';
    }

    document.getElementById('close-panel').addEventListener('click', hideInfoPanel);

    window.addEventListener('click', (event) => {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(globe);
      if (intersects.length > 0) {
        const point = intersects[0].point.normalize();
        const lat = Math.asin(point.y) * (180 / Math.PI);
        const lon = Math.atan2(point.x, point.z) * (180 / Math.PI);
        
        // Check if click is near a label
        const nearbyLabel = findNearbyLabel(lat, lon);
        if (nearbyLabel) {
          showInfoPanel(nearbyLabel);
        } else {
          hideInfoPanel();
        }
      }
      if (event.ctrlKey && event.metaKey) {
        const data = {
          "lat": lat,
          "lng": lon,
          "size": 1.7,
          "dotradius": 0.5,
          "color": "#D8D0C1",
          "text": "New point",
          "rotation": "0"
        };
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        return;
      };
    });

    function animate() {
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    };

    animate();

    function setupGlobe(globeImageUrl, locations) {
      let labels = [];
      switch (locations) {
        case "all":
          labels = [...geoData.continents, ...geoData.nations, ...geoData.cities, ...geoData.geography];
          break;
        case "continents":
          labels = geoData.continents;
          break;
        case "nations":
          labels = geoData.nations;
          break;
        case "cities":
          labels = geoData.cities;
          break;
        case "geography":
          labels = geoData.geography;
          break;
      }
      return new ThreeGlobe()
        .globeImageUrl(globeImageUrl)
        .showAtmosphere(false)
        .showGraticules(true)
        .labelsData(labels)
        .labelResolution([5])
        .labelText('text')
        .labelRotation('rotation')
        .labelSize('size')
        .labelDotRadius('dotradius')
        .labelColor('color')
        .labelTypeFace(font.data);
    }

    const layerSelect = document.getElementById('layer-select');
    const locationsSelect = document.getElementById('locations-select');

    layerSelect.addEventListener('change', (event) => {
      layer = event.target.value;
      scene.remove(globe);
      globe = setupGlobe('https://raw.githubusercontent.com/mihr-globe/mihr-globe.github.io/refs/heads/main/' + layer, locationsLayer);
      scene.add(globe);
    });

    locationsSelect.addEventListener('change', (event) => {
      locationsLayer = event.target.value;
      scene.remove(globe);
      globe = setupGlobe('https://raw.githubusercontent.com/mihr-globe/mihr-globe.github.io/refs/heads/main/' + layer, locationsLayer);
      scene.add(globe);
    });
  </script>
</body>

</html>
